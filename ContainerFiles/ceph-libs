# syntax = docker/dockerfile:1
# This Dockerfile uses multi-stage build to customize DEV and PROD images:
# https://docs.docker.com/develop/develop-images/multistage-build/

ARG VENV_TAG=3.12-latest
FROM ghcr.io/rackerlabs/genestack-images/openstack-venv:${VENV_TAG} AS dependency_build
ARG CACHEBUST=0
ARG CEPH_VERSION=v19.2.3
WORKDIR /opt
RUN export DEBIAN_FRONTEND=noninteractive \
  && apt update \
  && apt install --no-install-recommends -y \
                build-essential \
                ca-certificates \
                curl \
                gperf \
                jq \
                libbabeltrace-dev \
                libblkid-dev \
                libcap-dev \
                libcap-ng-dev \
                libcryptsetup-dev \
                libcurl4-openssl-dev \
                libffi-dev \
                libfuse-dev \
                libicu-dev \
                libibverbs-dev \
                liblmdb-dev \
                liblttng-ust-dev \
                liblua5.4-dev \
                liblz4-dev \
                libnbd-dev \
                libnl-genl-3-dev \
                liboath-dev \
                librabbitmq-dev \
                librdkafka-dev \
                librdmacm-dev \
                libre2-dev \
                libsqlite3-dev \
                libssl-dev \
                libthrift-dev \
                libudev-dev \
                lsb-release \
                nasm \
                python3-sphinx \
                python3-venv \
                thrift-compiler \
                wget

WORKDIR /opt
RUN git clone --recursive https://github.com/ceph/ceph.git
WORKDIR /opt/ceph
RUN git checkout ${CEPH_VERSION}
RUN /var/lib/openstack/bin/pip install src/python-common cython sphinx pyyaml packaging --upgrade --force
RUN . /var/lib/openstack/bin/activate \
  && /opt/ceph/install-deps.sh
RUN . /var/lib/openstack/bin/activate \
  && /opt/ceph/do_cmake.sh -DCMAKE_BUILD_TYPE=RelWithDebInfo \
                           -DWITH_MANPAGE=OFF \
                           -DWITH_MGR_DASHBOARD_FRONTEND=OFF \
                           -DWITH_CEPH_DEBUG_MUTEX=OFF \
                           -DWITH_CEPHFS=OFF \
                           -DWITH_MGR=OFF \
                           -DWITH_TESTS=OFF \
                           -DWITH_LTTNG=OFF


WORKDIR /opt/ceph/build
RUN ninja -j $(nproc) rbd rados
RUN ninja install

FROM ghcr.io/rackerlabs/genestack-images/openstack-venv:3.12-latest
LABEL maintainer="Rackspace"
LABEL vendor="Rackspace OpenStack Team"
LABEL org.opencontainers.image.name="ceph-libs"
LABEL org.opencontainers.image.description="Ceph client libraries built for the enterprise."
COPY --from=dependency_build /usr/local/lib /usr/local/lib
COPY --from=dependency_build /usr/lib/x86_64-linux-gnu /usr/lib/x86_64-linux-gnu
COPY --from=dependency_build /var/lib/openstack /var/lib/openstack
RUN export DEBIAN_FRONTEND=noninteractive \
  && apt-get update && apt-get upgrade -y \
  && apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
  && apt-get clean -y \
  && rm -rf /var/lib/apt/lists/* \
  && find / -name '*.pyc' -delete \
  && find / -name '*.pyo' -delete \
  && find / -name '__pycache__' -delete
ENV PATH="/usr/local/bin:/usr/local/sbin:/var/lib/openstack/bin:$PATH"
WORKDIR /var/lib/openstack
